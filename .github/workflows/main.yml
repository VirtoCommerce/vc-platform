name: CI

# Controls when the action will run. Triggers the workflow on push or pull request
# events but only for the master branch
on:
  push:
    branches: [ master, dev, dev-3.0.0, release/3.0.0 ]
  pull_request:
    branches: [ master, dev, dev-3.0.0, release/3.0.0 ]

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  unit-tests:
    # The type of runner that the job will run on
    runs-on: windows-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
    # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
    - uses: actions/checkout@v2

    - name: Install VirtoCommerce.GlobalTool
      run: dotnet tool install --global VirtoCommerce.GlobalTool --version 3.0.0-beta0010

    - name: Build
      run: vc-build Compile

    - name: Unit Tests
      run: vc-build Test -skip Restore+Compile

  build-package:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - name: Install VirtoCommerce.GlobalTool
      run: |
        dotnet tool install --global VirtoCommerce.GlobalTool --version 3.0.0-beta0010
        mv Directory.Build.Props Directory.Build.props

    - name: Build Package
      run: vc-build Compress -skip Test

    - name: Build Docker Image
      run: |
        pwsh -command "Invoke-WebRequest -Uri https://raw.githubusercontent.com/VirtoCommerce/jenkins-pipeline-scripts/master/resources/docker.core/linux/platform/Dockerfile -OutFile artifacts/publish/Dockerfile"
        docker build artifacts/publish --build-arg SOURCE=. --tag "docker.pkg.github.com/$GITHUB_REPOSITORY/platform:${{ github.sha }}" --tag leonidn/platform:3.0-preview-linux

    - name: Docker Login
      uses: azure/docker-login@v1
      with:
        login-server: docker.pkg.github.com
        username: $GITHUB_ACTOR
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Push Docker Image to GitHub
      run:  docker push "docker.pkg.github.com/$GITHUB_REPOSITORY/platform:${{ github.sha }}"

  swagger-validation:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    needs: build-package

    steps:
    - name: Install VirtoCommerce.GlobalTool
      run: dotnet tool install --global VirtoCommerce.GlobalTool --version 3.0.0-beta0010

    - name: Docker Login
      uses: azure/docker-login@v1
      with:
        login-server: docker.pkg.github.com
        username: $GITHUB_ACTOR
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Pull Platform Docker Image from GitHub
      run:  docker pull "docker.pkg.github.com/$GITHUB_REPOSITORY/platform:${{ github.sha }}"

    - name: Run container
      run: |
        docker tag docker.pkg.github.com/$GITHUB_REPOSITORY/platform:${{ github.sha }} leonidn/platform:3.0-preview-linux
        pwsh -command "Invoke-WebRequest -Uri https://raw.githubusercontent.com/lnetrebskii/vc-platform/release/3.0.0/docker/docker-compose.yml -OutFile docker-compose.yml"
        pwsh -command "Invoke-WebRequest -Uri https://raw.githubusercontent.com/lnetrebskii/vc-platform/release/3.0.0/docker/.env -OutFile .env"
        docker-compose up -d

    - name: Install Modules
      run: |
        pwsh -command "Invoke-WebRequest -Uri https://raw.githubusercontent.com/VirtoCommerce/jenkins-pipeline-scripts/master/resources/docker_v3/vc-setup-modules.ps1 -OutFile vc-setup-modules.ps1"
        pwsh -command "Invoke-WebRequest -Uri https://raw.githubusercontent.com/VirtoCommerce/jenkins-pipeline-scripts/master/resources/docker_v3/vc-check-installed-modules.ps1 -OutFile vc-check-installed-modules.ps1"
        pwsh -command "./vc-setup-modules.ps1 -ApiUrl http://localhost:8081 -NeedRestart -ContainerId leonidn_vc-platform-web_1 -Verbose -Debug"
        pwsh -command "./vc-check-installed-modules.ps1 -ApiUrl http://localhost:8081 -Verbose -Debug"

    - name: Install Sample Data
      run: |
        pwsh -command "Invoke-WebRequest -Uri https://raw.githubusercontent.com/VirtoCommerce/jenkins-pipeline-scripts/master/resources/docker_v3/vc-setup-sampledata.ps1 -OutFile vc-setup-sampledata.ps1"
        pwsh -command "./vc-setup-sampledata.ps1 -ApiUrl http://localhost:8081 -Verbose -Debug"

    - name: Swagger Schema Validation
      run: |
        pwsh -command "Invoke-WebRequest -Uri https://raw.githubusercontent.com/VirtoCommerce/jenkins-pipeline-scripts/master/resources/docker_v3/vc-get-swagger.ps1 -OutFile vc-get-swagger.ps1"
        pwsh -command "./vc-get-swagger.ps1 -ApiUrl http://localhost:8081 -OutFile swaggerSchema.json -Verbose -Debug"
        pwsh -command "vc-build ValidateSwaggerSchema -SwaggerSchemaPath swaggerSchema.json"

  publish:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    needs: [build-package, unit-tests, swagger-validation]

    steps:
    - name: Docker Login
      uses: azure/docker-login@v1
      with:
        login-server: docker.pkg.github.com
        username: $GITHUB_ACTOR
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Pull Platform Docker Image from GitHub
      run:  docker pull "docker.pkg.github.com/$GITHUB_REPOSITORY/platform:${{ github.sha }}"

    - name: Push Docker Image to hub.docker.io
      run: |
        docker tag docker.pkg.github.com/$GITHUB_REPOSITORY/platform:${{ github.sha }} leonidn/platform:latest-linux
        docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_TOKEN }}
        docker push leonidn/platform:latest-linux